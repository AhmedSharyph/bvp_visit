<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Patient Visit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

<div class="bg-white p-6 rounded-xl shadow-lg w-full max-w-lg animate__animated animate__fadeIn">
  <h2 class="text-2xl font-bold mb-4 text-center text-gray-800">Patient Visit</h2>

  <form id="visitForm" class="space-y-3" onsubmit="event.preventDefault(); saveVisit();">

    <select class="input-field" id="patient" required>
      <option value="">Loading patients...</option>
    </select>

    <select class="input-field" id="visit_type" required>
      <option>Nurse Visit</option>
      <option>Doctor Visit</option>
      <option>Non-Routine Visit</option>
    </select>

    <textarea class="input-field" id="findings" placeholder="Findings"></textarea>
    <textarea class="input-field" id="actions_taken" placeholder="Actions Taken"></textarea>
    <input class="input-field" type="date" id="next_visit_date">
    <input class="input-field" type="text" id="entered_by" placeholder="Staff Name (optional)">

    <button class="bg-green-600 text-white py-2 px-4 rounded w-full hover:bg-green-700 transition" type="submit">
      Save Visit
    </button>

    <p id="status" class="text-center mt-2 text-sm"></p>
  </form>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbxmcWZi7YlMySKKbBhKkhUh3Ynj1LuVMV0o7YlgcTCrp8AA4pDypJs4XZWWi2dLn7Mq/exec";

// Load patients for dropdown
async function loadPatients() {
  try {
    const res = await fetch(GAS_URL + "?action=getPatients");
    const data = await res.json();
    const sel = document.getElementById("patient");
    sel.innerHTML = '<option value="">Select Patient</option>';
    data.forEach(p => {
      sel.innerHTML += `<option value="${p.national_id}">${p.full_name} (${p.national_id})</option>`;
    });
  } catch {
    status.innerText = "⚠ Could not load patients.";
    status.className = "text-red-500 text-center mt-2";
  }
}

async function saveVisit() {
  const payload = {
    action: "addVisit",
    national_id: patient.value,
    visit_type: visit_type.value,
    findings: findings.value,
    actions_taken: actions_taken.value,
    next_visit_date: next_visit_date.value,
    entered_by: entered_by.value
  };

  try {
    const res = await fetch(GAS_URL, {
      method: "POST",
      body: JSON.stringify(payload)
    });
    const data = await res.json();

    if(data.error){
      status.innerText = `❌ ${data.error}`;
      status.className = "text-red-500 text-center mt-2";
      return;
    }

    status.innerText = "✅ Visit saved successfully!";
    status.className = "text-green-500 text-center mt-2";
    document.getElementById("visitForm").reset();
    setTimeout(()=> window.location.href="index.html",1500);

  } catch {
    status.innerText = "❌ Network error. Data not sent.";
    status.className = "text-red-500 text-center mt-2";
  }
}

// Initialize dropdown
loadPatients();
</script>

<style>
.input-field {
  @apply w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-400;
}
</style>

</body>
</html>
